var loader=function(){function loadImage(res,url){res.img=new Image,res._onLoaded=function(){res.img.removeEventListener("load",res._onLoaded),res.cb&&res.cb(res),onLoaded(res)},res.img.src=url,res.img.addEventListener("load",res._onLoaded)}function loadSpriteSheet(res,url){var xhr=res.xhr=new XMLHttpRequest;res._onLoaded=function(){if(200===xhr.status){xhr.removeEventListener("load",res._onLoaded),res.data=JSON.parse(xhr.responseText);var imgUrl=url.replace(/\/\w+\.json$/,"/"+res.data.meta.image);loader.add(imgUrl,function(spriteSheet){unpackSprites(res.data,spriteSheet.img),spriteSheet.images={},Object.keys(res.data.frames).forEach(function(key){spriteSheet.images[key]=resources[key]}),res.cb&&res.cb(res),onLoaded(res)}),res.img=resources[imgUrl]}},xhr.addEventListener("load",res._onLoaded),xhr.open("GET",url),xhr.send()}function onLoaded(res){console.log(res.url,res),res.loaded=!0,queueLength-=1,1>queueLength&&(callbacks.forEach(function(cb){cb()}),callbacks.length=0,loader.loaded=!0)}var unpackSprites,queueLength=0,resources={},callbacks=[],loader={add:function(url,cb){return resources[url]?void 0:(loader.loaded=!1,queueLength+=1,resources[url]={loaded:!1,url:url,cb:cb},/\.json$/.test(url)?loadSpriteSheet(resources[url],url):loadImage(resources[url],url),loader)},call:function(fn){return callbacks.push(fn),loader},get:function(url){return resources.url||loader.add(url),resources[url]},loaded:!0,unpackSprites:unpackSprites,resources:resources};return unpackSprites=function(){var cnv=document.createElement("canvas"),ctx=cnv.getContext("2d");return function(json,img){Object.keys(json.frames).forEach(function(imgName){var frame=json.frames[imgName];cnv.width=frame.sourceSize.w,cnv.height=frame.sourceSize.h,ctx.clearRect(0,0,cnv.width,cnv.height),ctx.drawImage(img,-frame.frame.x,-frame.frame.y),resources[imgName]={img:new Image},resources[imgName].img.src=cnv.toDataURL()})}}(),loader}(),D=function(loader){function getCssText(obj){var props={position:"absolute",left:obj.x&&obj.x+"px",top:obj.y&&obj.y+"px",opacity:1===obj.alpha?null:obj.alpha,display:!obj.visible&&"none",font:obj.font,color:obj.color};return Object.keys(props).filter(function(x){return props[x]}).reduce(function(css,name){return css+name+":"+props[name]+";"},"")}function extend(target,source){return Object.keys(source).forEach(function(key){target[key]=source[key]}),target}var _id=0,DisplayObject=function(){this._id=_id++,this.dirty=!0,this.parent=null,this.renderer=null,this.x=0,this.y=0,this.visible=!0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.rotate=0,this.shadow=0,this.width=1,this.height=0,this.rect=[this.x,this.y,this.width,this.height],this.interactive=!1,this.handlers={}};DisplayObject.prototype={_renderCanvas:function(ctx,renderer){if(this.renderer||(this.renderer=renderer),this.dirty=!1,!this.visible)return!0;var interactivesIndex=renderer.interactives.indexOf(this);this.interactive&&0>interactivesIndex&&renderer.interactives.push(this),!this.interactive&&interactivesIndex>=0&&renderer.interactives.splice(interactivesIndex,1),ctx.save(),renderer.prepareContext(this),this.rect=[ctx.currentTransform[4],ctx.currentTransform[5],this.width,this.height]},withinRect:function(x,y){var rect=this.rect;return x>rect[0]&&x<rect[0]+rect[2]&&y>rect[1]&&y<rect[1]+rect[3]},collidesWith:function(o){var that=this;return this.getCorners().some(function(corner){return o.withinRect(corner[0],corner[1])})||o.getCorners().some(function(corner){return that.withinRect(corner[0],corner[1])})},getCorners:function(){var r=this.rect;return[[r[0],r[1]],[r[0]+r[2],r[1]],[r[0]+r[2],r[1]+r[3]],[r[0],r[1]+r[3]]]},_renderDOM:function(node,renderer){this.renderer||(this.renderer=renderer),this.dirty&&this.$el.setAttribute("style",getCssText(this)),this.$el.parentNode!==node&&node.appendChild(this.$el),this.dirty=!1},on:function(evName,fn){this.handlers[evName]?this.handlers[evName].push(fn):this.handlers[evName]=[fn]},off:function(evName,fn){this.handlers[evName]&&this.handlers[evName].splice(this.handlers[evName].indexOf(fn),1)},set:function(key,value){if(this.onset&&this.onset(key,value),"object"==typeof key){var that=this;if(Object.keys(key).forEach(function(prop){that[key]!==key[prop]&&(that[prop]=key[prop],that.dirty=!0)}),!that.dirty)return}else{if(this[key]===value)return;this[key]=value,this.dirty=!0}this.renderer&&(this.renderer.dirty=!0)}};var Container=function(config){DisplayObject.call(this),this.children=[],config&&this.set(config)};Container.prototype=extend(Object.create(DisplayObject.prototype),{renderCanvas:function(ctx,renderer){this._renderCanvas(ctx,renderer)||(this.children.forEach(function(child){child.renderCanvas(ctx,renderer)}),ctx.restore())},renderDOM:function(node,renderer){this.$el||(this.$el=document.createElement("div"));var $el=this.$el;this.children.forEach(function(child){child.renderDOM($el,renderer)}),this._renderDOM(node,renderer)},addChild:function(el){this.dirty=!0,el.dirty=!0,el.parent=this,this.children.push(el),this.renderer&&(this.renderer.dirty=!0)},removeChild:function(el){el.parent=null,this.children.splice(this.children.indexOf(el),1),this.$el&&this.$el.removeChild(el.$el),this.renderer&&(this.renderer.dirty=!0,this.renderer.interactives.splice(this.renderer.interactives.indexOf(this),1))},removeChildren:function(){this.children.forEach(this.removeChild,this)}});var Sprite=function(url,config){DisplayObject.call(this),this.img=loader.get(url).img,this.width=this.img.width,this.height=this.img.height,this.centered=!1,config&&this.set(config)};Sprite.prototype=extend(Object.create(DisplayObject.prototype),{renderCanvas:function(ctx,renderer){if(!this._renderCanvas(ctx,renderer)){var x=this.centered?-this.img.width/2:0,y=this.centered?-this.img.height/2:0;ctx.drawImage(this.img,x,y),this.rect[0]+=x,this.rect[1]+=y,ctx.restore()}},renderDOM:function(node,renderer){this.dirty&&(this.$el=this.img,this._renderDOM(node,renderer))},onset:function(key,value){var img;"object"==typeof key?img=key[img]:"img"===key&&(img=value),img&&(this.width=img.width,this.height=img.height)}});var Text=function(config){DisplayObject.call(this),this.font="24px sans",this.text="",this.color="black",this.centered=!0,config&&this.set(config)};return Text.prototype=extend(Object.create(DisplayObject.prototype),{renderCanvas:function(ctx,renderer){if(!this._renderCanvas(ctx,renderer)){ctx.font=this.font,ctx.fillStyle=this.color;var em=ctx.measureText("M").width,x=this.centered?-ctx.measureText(this.text).width/2:0,y=this.centered?em/2:em;ctx.fillText(this.text,x,y),this.rect[0]-=x,this.rect[1]-=y,ctx.restore()}},renderDOM:function(node,renderer){this.dirty&&(this.$el||(this.$el=document.createElement("span")),this.$el.innerHTML=this.text,this._renderDOM(node,renderer))}}),{Container:Container,Sprite:Sprite,Text:Text}}(loader),R=function(){var DOMRenderer=function(view,options){options=options||{},this.view=view||document.createElement("div"),this.interactives=[];var that=this,events=["mousedown","click","touchstart"],addHandler=function(evName){that.view.addEventListener(evName,function(ev){that.interactives.forEach(function(obj){obj.withinRect(ev.offsetX,ev.offsetY)&&obj.handlers[evName]&&obj.handlers[evName].forEach(function(fn){fn(ev)})})})};events.forEach(addHandler),this.dirty=!0,this.view.width=options.width||400,this.view.height=options.height||400};DOMRenderer.prototype={render:function(stage){this.view.getAttribute("style")||this.view.setAttribute("style","position: relative; overflow: hidden; width:"+this.view.width+"px;height:"+this.view.height+"px"),this.dirty&&(this.dirty=!1,stage.renderDOM(this.view,this))}};var canvasRenderer=function(view,options){options=options||{},this.view=view||document.createElement("canvas"),this.context=this.view.getContext("2d");var ctx=this.context;ctx.currentRotate=0,ctx.currentTransform=[1,0,0,1,0,0];var save=ctx.save;ctx.savedTransforms=[],ctx.savedRotates=[],ctx.save=function(){ctx.savedTransforms.push(ctx.currentTransform),ctx.savedRotates.push(ctx.currentRotate),save.call(ctx)};var restore=ctx.restore;ctx.restore=function(){restore.call(ctx),ctx.currentTransform=ctx.savedTransforms.pop(),ctx.currentRotate=ctx.savedRotates.pop()},this.interactives=[];var that=this,events=["mousedown","click","touchstart"],addHandler=function(evName){that.view.addEventListener(evName,function(ev){that.interactives.forEach(function(obj){obj.withinRect(ev.offsetX,ev.offsetY)&&obj.handlers[evName]&&obj.handlers[evName].forEach(function(fn){fn(ev)})})})};events.forEach(addHandler),this.dirty=!0,this.view.width=options.width||400,this.view.height=options.height||400};return canvasRenderer.prototype={render:function(stage){this.dirty&&(this.dirty=!1,this.context.clearRect(0,0,this.view.width,this.view.height),this.context.save(),stage.renderCanvas(this.context,this),this.context.restore())},prepareContext:function(state){var ctx=this.context;ctx.currentTransform=[ctx.currentTransform[0]*state.scaleX,0,0,ctx.currentTransform[3]*state.scaleY,ctx.currentTransform[4]+state.x,ctx.currentTransform[5]+state.y],ctx.setTransform.apply(ctx,ctx.currentTransform),ctx.currentRotate=ctx.currentRotate+state.rotate*Math.PI/180,ctx.rotate(ctx.currentRotate),ctx.globalAlpha=ctx.globalAlpha*state.alpha,ctx.shadowColor="black",ctx.shadowBlur=state.shadow}},{canvasRenderer:canvasRenderer,DOMRenderer:DOMRenderer}}(),ticker=function(){function runCallbacks(delta){ticker.callbacks.forEach(function(cb){cb.fn.call(cb.ctx,delta)})}function tick(){if(ticker.callbacks.length&&ticker.running){var currDate=dateFn(),elapsedMS=ticker.elapsedMS=currDate-lastDate;ticker.FPS=1e3/elapsedMS;var delta=elapsedMS/(1e3/ticker.targetFPS);runCallbacks(delta),lastDate=currDate,RAF(tick)}}var dateFn=performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),RAF=requestAnimationFrame||function(fn){setTimeout(fn,1e3/ticker.targetFPS-ticker.elapsedMS)},lastDate=dateFn(),ticker={callbacks:[],add:function(fn,ctx){return ticker.callbacks.push({fn:fn,ctx:ctx}),ticker.tryStart(),ticker},remove:function(fn,ctx){return ticker.callbacks=ticker.callbacks.filter(function(cb){return cb.fn!==fn||cb.ctx!==ctx}),ticker.tryStop(),ticker},tryStart:function(){!ticker.running&&ticker.callbacks.length&&(ticker.running=!0,lastDate=dateFn(),tick())},tryStop:function(){ticker.callbacks.length||(ticker.running=!1)},running:!1,targetFPS:60,FPS:60,elapsedMS:0};return ticker}(),tween=function(ticker){function animate(obj,state,finalState,time,easing){easing=easing||tween.easing.LINEAR;var props=Object.keys(finalState),elapsed=0,diff={},startState={};props.forEach(function(key){startState[key]=state[key],diff[key]="number"==typeof finalState[key]?finalState[key]-startState[key]:0});var step=function(delta){if(elapsed+=ticker.elapsedMS,time>elapsed){var value=easing(elapsed/time);props.forEach(function(key){diff[key]&&(obj.setter?obj.setter.call(state,key,startState[key]+diff[key]*value):state[key]=startState[key]+diff[key]*value)})}else ticker.remove(step),props.forEach(function(key){obj.setter?obj.setter.call(state,key,finalState[key]):state[key]=finalState[key]}),nextCb(obj)};obj.stepFn=step,ticker.add(step)}function nextCb(obj){obj._callbacks.length?obj._callbacks.shift()():obj.running=!1}tweenObjs=[];var Tween=function(target,setter){this.target=target,this.setter=setter,this._callbacks=[],this.running=!1};Tween.prototype={to:function(finalState,time,easing){return this.running?this._callbacks.push(animate.bind(null,this,this.target,finalState,time,easing)):(this.running=!0,animate(this,this.target,finalState,time,easing)),this},call:function(fn){if(this.running){var that=this;this._callbacks.push(function(){fn(),nextCb(that)})}else this.running=!0,fn(),nextCb(this);return this},stop:function(){ticker.remove(this.stepFn)}};var tween={get:function(obj,setter){var tween=new Tween(obj,setter);return tweenObjs.push(tween),tween},easing:{LINEAR:function(x){return x}},removeAllTweens:function(obj){tweenObjs=tweenObjs.filter(function(tween){return tween.target!==obj?tween:void tween.stop()})}};return tween}(ticker),config={root:{width:315,height:535,scaleX:1,scaleY:1,interactive:!0},stage1:{bg:{imgUrl:"screen1_bg.png"}},topBar:{y:30},exit:{x:300,button:{interactive:!0,imgUrl:"exit.png",centered:!0},cross:{imgUrl:"exit_cross.png",centered:!0}},lives:{x:30,count:3,offset:30,life:{imgUrl:"lives.png",centered:!0}},player:{x:165,y:390,hitbox:{x:-40,y:-50,width:80,height:90},image:{imgUrl:"screen1_player.png",centered:!0},points:0,maxPoints:10,movementSpeed:200},countdown:{x:165,y:275,centered:!0,shadow:10,font:"48px sans",color:"white",alpha:0},items:{imgUrl:"screen1_item{n}.png",digits:2,count:9,catchAnim:{length:500,endScale:.2},catchTime:500,fallTime:4500,fallFreqMax:4e3,fallFreqMin:1e3},stage2:{bg:{imgUrl:"screen2_bg_v.png"}},message:{x:0,y:60,img:{imgUrl:"screen2_text2.png",x:0,y:50,scaleX:.66,scaleY:.66}},text:{imgUrl:"screen2_text3.png",x:205,y:175,scaleX:.5,scaleY:.5,interactive:!0},text2:{imgUrl:"screen2_text4.png",x:210,y:170,interactive:!0},openButton:{imgUrl:"screen2_button.png",x:127,y:188,interactive:!0}},game=function(){var root,topBar,exitGame=function(){game.onexit&&game.onexit(),ticker.running=!1},stages={0:function(renderer){root=new D.Container(config.root),root.set({width:renderer.view.width,height:renderer.view.height});var animate=function(delta){renderer.render(root)};ticker.add(animate);var exit=new D.Container(config.exit),exitBtn=new D.Sprite(config.exit.button.imgUrl,config.exit.button);exit.addChild(exitBtn);var exitCross=new D.Sprite(config.exit.cross.imgUrl,config.exit.cross);exit.addChild(exitCross),exitBtn.on("click",exitGame),topBar=new D.Container(config.topBar),topBar.addChild(exit),stages[1](renderer)},1:function(renderer){function unlockGame(){stage.on("mousedown",function(ev){tween.removeAllTweens(player),(player.scaleX>0&&ev.offsetX>player.x||player.scaleX<0&&ev.offsetX<player.x)&&player.set({scaleX:-1*player.scaleX});var distance=Math.abs(player.x-ev.offsetX);tween.get(player,player.set).to({x:ev.offsetX},distance/config.player.movementSpeed*1e3)}),dropItems()}function dropItems(){function collision(){item.collidesWith(playerHitbox)&&(tween.removeAllTweens(item),ticker.remove(collision),catchCb(item))}if(lives.count&&!(player.points>=player.maxPoints)){var itemUrl=items.shift();items.push(itemUrl),console.log(itemUrl);var item=new D.Sprite(itemUrl);item.set({centered:!0,y:-50,x:.1*renderer.view.width+Math.random()*renderer.view.width*.8}),itemCnt.addChild(item),tween.get(item,item.set).to({y:renderer.view.height+50,rotate:480},config.items.fallTime).call(function(){tween.removeAllTweens(item),ticker.remove(collision),fallCb(item)}),ticker.add(collision),dropTimeout=setTimeout(dropItems,(Math.random()*(config.items.fallFreqMax-config.items.fallFreqMin)+config.items.fallFreqMin)%config.items.fallFreqMax)}}function fallCb(item){if(itemCnt.removeChild(item),lives.count){var livesLeft=lives.removeLife();livesLeft||finish()}}function catchCb(item){player.points+=1,player.points>=player.maxPoints&&finish();var aimTimeout,aimTime=config.items.catchTime,aim=function(){aimTime-=50,tween.removeAllTweens(item),tween.get(item,item.set).to({x:player.x,y:player.y,scaleX:.2,scaleY:.2},aimTime).call(function(){clearInterval(aimTimeout),itemCnt.removeChild(item)}),aimTime>0&&(aimTimeout=setTimeout(aim,50))};aim()}function finish(){clearTimeout(dropTimeout),stage.removeChild(lives),tween.get(stage,stage.set).to({alpha:0},500).call(function(){stage.removeChildren(),root.removeChild(stage)}),stages[2](renderer)}var stage=new D.Container({interactive:!0,width:root.width,height:root.height});root.addChild(stage),root.addChild(topBar);var bg=new D.Sprite(config.stage1.bg.imgUrl);stage.addChild(bg);var lives=new D.Container(config.lives);topBar.addChild(lives);for(var i=0;i<config.lives.count;i++){var life=new D.Sprite(config.lives.life.imgUrl,config.lives.life);life.set({x:i*config.lives.offset}),lives.addChild(life)}lives.removeLife=function(){return lives.removeChild(lives.children[lives.children.length-1]),lives.count-=1,lives.count};var player=new D.Container(config.player);player.set({x:500});var playerImg=new D.Sprite(config.player.image.imgUrl,config.player.image);player.addChild(playerImg);var playerHitbox=new D.Container(config.player.hitbox);player.addChild(playerHitbox),stage.addChild(player);var countdown=new D.Text(config.countdown);stage.addChild(countdown);var itemCnt=new D.Container;stage.addChild(itemCnt),tween.get(player,player.set).to({x:config.player.x},2e3),tween.get(countdown,countdown.set).call(countdown.set.bind(countdown,"text",3)).to({alpha:1},200).to({},600).to({alpha:0},200).call(countdown.set.bind(countdown,"text",2)).to({alpha:1},200).to({},600).to({alpha:0},200).call(countdown.set.bind(countdown,"text",1)).to({alpha:1},200).to({},600).to({alpha:0},200).call(function(){stage.removeChild(countdown)}).call(unlockGame);for(var items=[],i=config.items.count;i--;)items.push(config.items.imgUrl);items=items.map(function(img,i){for(var idx=(i+1).toString();idx.length<config.items.digits;)idx="0"+idx;return img.replace("{n}",idx)})},2:function(){var stage2=new D.Container({interactive:!0,width:root.width,height:root.height,alpha:0}),bg2=new D.Sprite(config.stage2.bg.imgUrl,{});root.removeChild(topBar),stage2.addChild(bg2),root.addChild(stage2),root.addChild(topBar),tween.get(stage2,stage2.set).to({alpha:1},500).call(function(){console.log(stage2)});var message=new D.Container(config.message);stage2.addChild(message);var messageImg=new D.Sprite(config.message.img.imgUrl,config.message.img);message.addChild(messageImg);var text=new D.Sprite(config.text.imgUrl,config.text);message.addChild(text);var openButton=new D.Sprite(config.openButton.imgUrl,config.openButton);message.addChild(openButton),openButton.on("click",function(){game.onopen&&game.onopen()})}};return{stages:stages,exit:exitGame}}();window.NjuGame=function(gameCfg){var assets=gameCfg.assets,popout=document.createElement("div"),renderer=new R.canvasRenderer(null,{width:config.root.width,height:config.root.height});popout.appendChild(renderer.view),popout.style="position: fixed; top:0; bottom:0; right:0; left: 0; background:#00A6CF",assets.forEach(function(asset){loader.add(asset)}),loader.call(function(){var adTimeout=setTimeout(function(){game.exit()},gameCfg.timeout),clearAdTimeout=function(){clearTimeout(adTimeout),renderer.view.removeEventListener("mousedown",clearAdTimeout)};renderer.view.addEventListener("mousedown",clearAdTimeout),document.body.appendChild(popout),game.onexit=function(){document.body.removeChild(popout)},game.onopen=function(){window.location.href=gameCfg.click},game.stages[0](renderer)})};
